
        // Gate Control Functions
        function listenToGateState() {
            if (!currentDeviceId) return;
            
            // Listen to gate state
            const gateRef = database.ref(`devices/${currentDeviceId}/gate`);
            gateRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    gateState = data.state || false;
                    gateAutoMode = data.autoMode !== undefined ? data.autoMode : true;
                    if (data.password) {
                        gatePassword = data.password;
                        currentPasswordSpan.textContent = data.password;
                    }
                    updateGateUI();
                }
            });

            // Listen to gate auto mode
            const gateAutoModeRef = database.ref(`devices/${currentDeviceId}/gateAutoMode`);
            gateAutoModeRef.on('value', (snapshot) => {
                gateAutoMode = snapshot.val() || false;
                updateGateUI();
            });
        }

        async function toggleGate() {
            if (!currentDeviceId) {
                alert('Please select a device first');
                return;
            }

            // Check if gate is in auto mode
            if (gateAutoMode) {
                alert('Gate is in auto mode. Switch to manual mode to control gate from app.');
                return;
            }

            try {
                const newGateState = !gateState;
                await database.ref(`devices/${currentDeviceId}/gate/state`).set(newGateState);
            } catch (error) {
                console.error('Error toggling gate:', error);
                alert('Error toggling gate: ' + error.message);
            }
        }

        async function changeGatePassword() {
            if (!currentDeviceId) {
                alert('Please select a device first');
                return;
            }

            const newPassword = gatePasswordInput.value.trim();
            
            if (!newPassword) {
                alert('Please enter a new password');
                return;
            }

            if (newPassword.length < 4) {
                alert('Password must be at least 4 characters long');
                return;
            }

            try {
                await database.ref(`devices/${currentDeviceId}/gate/password`).set(newPassword);
                gatePasswordInput.value = '';
                alert('Gate password updated successfully!');
            } catch (error) {
                console.error('Error changing gate password:', error);
                alert('Error changing gate password: ' + error.message);
            }
        }

        async function toggleGateAutoMode() {
            if (!currentDeviceId) {
                alert('Please select a device first');
                return;
            }

            try {
                const newGateAutoMode = !gateAutoMode;
                await database.ref(`devices/${currentDeviceId}/gateAutoMode`).set(newGateAutoMode);
            } catch (error) {
                console.error('Error toggling gate auto mode:', error);
                alert('Error toggling gate auto mode: ' + error.message);
            }
        }

        function updateGateUI() {
            // Update gate status
            if (gateState) {
                gateStatus.textContent = 'OPEN';
                gateStatus.className = 'gate-status open';
                gateBtn.textContent = 'CLOSE GATE';
                gateBtn.className = 'switch-btn on';
                gateStateIndicator.textContent = 'OPEN';
            } else {
                gateStatus.textContent = 'CLOSED';
                gateStatus.className = 'gate-status closed';
                gateBtn.textContent = 'OPEN GATE';
                gateBtn.className = 'switch-btn off';
                gateStateIndicator.textContent = 'CLOSED';
            }

            // Update gate auto mode
            if (gateAutoMode) {
                gateAutoModeBtn.textContent = 'ON';
                gateAutoModeBtn.className = 'switch-btn on';
                gateAutoModeStatus.textContent = 'AUTO MODE';
                gateBtn.disabled = true;
                gateBtn.title = 'Switch to manual mode to control gate';
            } else {
                gateAutoModeBtn.textContent = 'OFF';
                gateAutoModeBtn.className = 'switch-btn off';
                gateAutoModeStatus.textContent = 'MANUAL';
                gateBtn.disabled = false;
                gateBtn.title = 'Click to toggle gate';
            }

            // Update current password display
            currentPasswordSpan.textContent = gatePassword;
        }
